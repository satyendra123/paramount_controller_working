#include <SoftwareSerial.h>
// USR is connected to Arduino RX (pin 0) and TX (pin 1)

#define RS485_RX_PIN_1 4
#define RS485_TX_PIN_1 5

SoftwareSerial displaySerial(RS485_RX_PIN_1, RS485_TX_PIN_1);

unsigned long previousMillis = 0;
const long interval = 3000;

String vehicleNumber = "";

void setup() {
  Serial.begin(9600);
  displaySerial.begin(9600);
  pinMode(13, OUTPUT);
}

void loop() {
  if (Serial.available() > 0) {
    String data = Serial.readStringUntil('%');
    data += "%";

    if (data == "|CLEAR%") {
      Serial.println("|C|1|6|");
      displaySerial.println("|C|1|6|");
    }

    else if (data == "|WELCOME%") {
      Serial.println("|C|1|4|1|0-0-WELCOME|");
      displaySerial.println("|C|1|4|1|0-0-WELCOME|");
    }

    else if (data.startsWith("|VEHICLE_NUMBER|")) {
      vehicleNumber = data.substring(16, data.length() - 1);
      String response = "|C|1|4|1|0-0-" + vehicleNumber + "|";
      Serial.println(response);
      displaySerial.println(response);
      vehicleNumber = "";
    }

    else if (data == "|OPENEN%") {
      digitalWrite(13, HIGH);
      delay(5000);
      digitalWrite(13, LOW);
    }
  }


  unsigned long currentMillis = millis();
  if (currentMillis - previousMillis >= interval) {
    previousMillis = currentMillis;
    Serial.println("|HLT%");
  }
}
